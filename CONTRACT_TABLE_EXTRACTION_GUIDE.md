# 📊 合同表格提取功能使用指南

## 功能概述

LibreChat 现已集成强大的文档分析和图表提取功能，可以自动从上传的 PDF 和 Word 文档中提取数值数据，并导出为 Excel 表格或包含可视化图表的 PDF 文件。

### ✨ 主要特性

1. **智能数据提取**
   - 自动识别文档中的所有数值数据
   - 支持表格、列表、段落中的数字信息
   - 智能分类（财务、指标、时间线等）

2. **隐私保护（匿名化）**
   - 自动检测并替换敏感信息
   - 公司名称 → [COMPANY_A], [COMPANY_B]
   - 人名 → [PERSON_A], [PERSON_B]
   - 邮箱、电话、地址等自动匿名化

3. **多格式导出**
   - **Excel**: 多工作表格式，包含摘要和详细数据
   - **PDF**: 包含可视化柱状图和折线图

4. **可视化预览**
   - 在线预览检测到的图表信息
   - 查看图表类型、数据点数量、来源页码等

---

## 🚀 使用步骤

### 步骤 1: 上传文档

1. 在聊天界面点击附件图标（📎）
2. 选择 PDF 或 Word 文档上传
3. 等待文件上传完成

### 步骤 2: 提取图表数据

在上传文档的消息下方，会出现蓝色按钮：

```
[📊 提取文档图表]
```

点击此按钮后：
- 系统会自动生成分析提示词
- AI 将分析整个文档并提取所有数值数据
- 提取过程包含自动匿名化处理

**预计时间**: 根据文档大小，通常需要 10-60 秒

### 步骤 3: 查看提取结果

AI 返回结果后，消息下方会显示：

```
[下载 Excel] [下载 PDF] [预览图表]
检测到 X 个图表
```

### 步骤 4: 预览图表（可选）

点击 **[预览图表]** 按钮可以查看：
- 图表标题和类型（柱状图/折线图）
- 数据分类和来源页码
- 数据点数量
- 图表说明

### 步骤 5: 导出数据

**Excel 导出**:
1. 点击 **[下载 Excel]** 绿色按钮
2. 文件将自动下载，包含：
   - **摘要工作表**: 所有图表的概览
   - **图表1, 图表2...**: 每个图表的详细数据和元数据

**PDF 导出**:
1. 点击 **[下载 PDF]** 红色按钮
2. 文件将自动下载，包含：
   - **封面页**: 报告标题和生成时间
   - **摘要页**: 所有图表列表
   - **图表页**: 每个图表一页，包含可视化柱状图/折线图

---

## 📋 Excel 文件结构

### 摘要工作表
| 列名 | 说明 |
|------|------|
| 图表编号 | 图表序号 (1, 2, 3...) |
| 标题 | 图表标题 |
| 类型 | bar (柱状图) 或 line (折线图) |
| 数据点数 | 数据项数量 |
| 来源页 | 原文档页码或分类 |
| 说明 | 图表说明文字 |

### 图表工作表（每个图表一个）
**数据区域**:
| 标签 | 数值 |
|------|------|
| Q1 2024 | 150000 |
| Q2 2024 | 200000 |
| ... | ... |

**元数据区域**（数据下方）:
| 属性 | 值 |
|------|------|
| 图表标题 | 2024年季度营收 |
| 图表类型 | bar |
| 来源页 | 第 3 页 |
| 说明 | 显示2024年各季度营收增长趋势 |

---

## 📄 PDF 文件结构

### 第 1 页: 封面
- 报告标题：**合同数据分析报告**
- 生成时间

### 第 2 页: 摘要
- 图表总数
- 图表列表（编号、来源页、标题）

### 第 3+ 页: 可视化图表（每页一个）
每个图表页包含：

**1. 图表信息**
- 来源页码标注（右上角）
- 图表标题（加粗）

**2. 可视化图形**
- **柱状图**: 蓝色柱形，顶部显示数值
- **折线图**: 红色线条和数据点，标注数值

**3. 详细信息**
- 图表类型标识
- 图表说明文字（底部）

---

## 🔒 隐私保护（自动匿名化）

系统会自动检测并替换以下敏感信息：

| 类型 | 检测模式 | 替换为 |
|------|----------|--------|
| 公司名称 | XX Inc., XX LLC, XX Ltd., XX Corp. 等 | [COMPANY_A], [COMPANY_B]... |
| 人名 | Mr./Mrs./Dr. + 姓名 | [PERSON_A], [PERSON_B]... |
| 邮箱 | user@domain.com | [EMAIL_A], [EMAIL_B]... |
| 电话 | +1-234-567-8900, (123) 456-7890 | [PHONE_A], [PHONE_B]... |
| 地址 | 街道地址模式 | [ADDRESS_A], [ADDRESS_B]... |
| 网址 | http://..., https://... | [URL_A], [URL_B]... |

**注意**: 数值数据（金额、数量等）不会被匿名化，因为这些是分析的核心内容。

---

## 💡 最佳实践

### 1. 文档准备
- ✅ 确保 PDF 是文本格式（非扫描件）
- ✅ 表格应有清晰的标题和列名
- ✅ 数值应使用标准格式（避免特殊字符）

### 2. 提取优化
- 📄 对于大文档（>50页），考虑分段上传
- 🔍 如果首次提取不理想，可以重新提取或手动补充提示词
- 📊 复杂图表建议手动验证数据准确性

### 3. 结果验证
- 👀 使用"预览图表"功能快速检查提取结果
- ✏️ 如发现遗漏数据，可以在对话中要求 AI 补充
- 📝 导出前确认匿名化效果符合要求

---

## 🛠️ 技术实现

### 后端服务
- **ContractController**: 处理分析请求和导出操作
- **pdfProcessor**: PDF 页面提取和提示词生成
- **chartGenerator**: 可视化图表绘制（PDFKit）
- **anonymize**: 敏感信息检测和替换

### 前端组件
- **AnalyzeContractButton**: 触发分析的蓝色按钮
- **ExportButtons**: Excel/PDF 导出和预览控制
- **useContractAnalysis**: React Hook 处理 API 调用

### API 端点
```
POST /api/contract/analyze     - 获取分析提示词
POST /api/contract/export/excel - 导出 Excel
POST /api/contract/export/pdf   - 导出 PDF
```

---

## ❓ 常见问题

### Q: 为什么有些图表没有被检测到？
**A**: 可能原因：
1. 数据格式不标准（如文字描述的数字）
2. 图表在扫描件中（OCR 未启用）
3. 数据点太少（<2个数据点）

**解决方法**: 在对话中明确告诉 AI 哪一页有数据，让它重新提取。

### Q: 可以手动编辑导出的图表吗？
**A**: 可以！
- **Excel**: 直接在 Excel 中编辑数据和创建图表
- **PDF**: 导出后可使用 PDF 编辑工具修改

### Q: 匿名化可以关闭吗？
**A**: 当前版本默认启用匿名化。如需原始数据，可以：
1. 在提示词中说明"保留所有原始信息"
2. 或在导出后手动替换匿名标签

### Q: 支持的文档格式有哪些？
**A**:
- ✅ PDF（文本格式）
- ✅ Word (.docx)
- ⚠️ 扫描件 PDF 需要 OCR（未来版本）
- ❌ 图片格式（JPG, PNG）

### Q: Excel/PDF 导出失败怎么办？
**A**: 检查：
1. AI 返回的数据格式是否正确（应包含 JSON）
2. 网络连接是否稳定
3. 浏览器控制台是否有错误信息
4. 尝试刷新页面重新导出

---

## 🔄 版本历史

### v1.0 (当前版本)
- ✅ 基础图表提取功能
- ✅ Excel 和 PDF 导出
- ✅ 自动匿名化
- ✅ 图表预览功能
- ✅ 可视化图表生成

### 计划中功能 (v1.1)
- 🔜 页面级别的逐页分析
- 🔜 OCR 支持扫描件
- 🔜 更多图表类型（饼图、散点图）
- 🔜 批量文档处理
- 🔜 自定义匿名化规则

---

## 📞 支持

如遇到问题或有改进建议，请：
1. 查看本文档的常见问题部分
2. 在聊天中向 AI 提问
3. 提交 GitHub Issue（如适用）

---

**祝使用愉快！** 🎉
